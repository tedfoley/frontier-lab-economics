<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frontier AI Lab Economics Simulator</title>
<script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#f8fafc;--surface:#fff;--border:#e2e8f0;--text:#1e293b;--muted:#64748b;
--primary:#2563eb;--green:#16a34a;--red:#dc2626;--purple:#7c3aed;--orange:#ea580c;
--radius:8px;--shadow:0 1px 3px rgba(0,0,0,.1)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
background:var(--bg);color:var(--text);line-height:1.6;padding:0}
a{color:var(--primary)}

/* Header */
.header{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:#fff;
padding:2.5rem 2rem 2rem;text-align:center}
.header h1{font-size:2rem;font-weight:700;margin-bottom:.3rem}
.header .subtitle{color:#94a3b8;font-size:1.05rem;max-width:750px;margin:0 auto .8rem}
.header .model-note{color:#64748b;font-size:.85rem;max-width:750px;margin:0 auto}

/* Tabs */
.tabs{display:flex;justify-content:center;gap:0;background:#1e293b;padding:0 2rem;
border-top:1px solid #334155}
.tab-btn{background:none;border:none;color:#94a3b8;padding:.75rem 1.5rem;font-size:.95rem;
cursor:pointer;border-bottom:3px solid transparent;transition:.2s}
.tab-btn:hover{color:#fff}
.tab-btn.active{color:#fff;border-bottom-color:var(--primary)}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:1.5rem}
.tab-content{display:none}
.tab-content.active{display:block}

/* Simulator layout */
.sim-grid{display:grid;grid-template-columns:380px 1fr;gap:1.5rem;align-items:start}
@media(max-width:960px){.sim-grid{grid-template-columns:1fr}}

/* Controls */
.controls{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
padding:1.25rem;box-shadow:var(--shadow);position:sticky;top:1rem;overflow:hidden;
max-height:calc(100vh - 2rem);overflow-y:auto}
.control-group{margin-bottom:1rem}
.control-group h3{font-size:.85rem;text-transform:uppercase;letter-spacing:.05em;
color:var(--muted);margin-bottom:.6rem;padding-bottom:.3rem;border-bottom:1px solid var(--border)}
.slider-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.45rem}
.slider-row label{flex:0 0 140px;font-size:.82rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.slider-row input[type=range]{flex:1 1 0;min-width:0;height:6px;-webkit-appearance:none;appearance:none;
background:#e2e8f0;border-radius:3px;outline:none}
.slider-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;
height:16px;border-radius:50%;background:var(--primary);cursor:pointer}
.slider-row .val{flex:0 0 55px;text-align:right;font-size:.82rem;font-weight:600;
font-variant-numeric:tabular-nums;color:var(--primary);white-space:nowrap}
.advanced-toggle{background:none;border:none;color:var(--primary);font-size:.82rem;
cursor:pointer;padding:.3rem 0;display:flex;align-items:center;gap:.3rem}
.advanced-toggle .arrow{transition:transform .2s;display:inline-block}
.advanced-toggle .arrow.open{transform:rotate(90deg)}
.advanced-content{display:none}
.advanced-content.open{display:block}
.checkbox-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.45rem}
.checkbox-row label{font-size:.82rem;color:var(--text)}
.checkbox-row input[type=checkbox]{width:16px;height:16px;accent-color:var(--primary)}
.entry-exit-params{display:none;margin-left:1.5rem}
.entry-exit-params.open{display:block}

/* Presets */
.presets{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.8rem;padding-top:.8rem;
border-top:1px solid var(--border)}
.preset-btn{flex:1;min-width:70px;padding:.45rem .5rem;border:1.5px solid var(--border);
border-radius:6px;background:var(--surface);font-size:.78rem;font-weight:600;
cursor:pointer;transition:.15s;text-align:center}
.preset-btn:hover{border-color:var(--primary);color:var(--primary)}
.preset-btn.bear{border-color:#fca5a5;color:var(--red);background:#fef2f2}
.preset-btn.base{border-color:#93c5fd;color:var(--primary);background:#eff6ff}
.preset-btn.bull{border-color:#86efac;color:var(--green);background:#f0fdf4}
.preset-btn.agi{border-color:#c4b5fd;color:var(--purple);background:#f5f3ff}

/* Stats cards */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin-bottom:1rem}
@media(max-width:600px){.stats{grid-template-columns:repeat(2,1fr)}}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
padding:.75rem 1rem;box-shadow:var(--shadow)}
.stat-card .label{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
.stat-card .value{font-size:1.4rem;font-weight:700;font-variant-numeric:tabular-nums}
.stat-card .value.positive{color:var(--green)}
.stat-card .value.negative{color:var(--red)}
.stat-card .value.neutral{color:var(--orange)}
.stat-card .sub{font-size:.72rem;color:var(--muted)}

/* Charts */
.charts{min-width:0}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
padding:.5rem;margin-bottom:1rem;box-shadow:var(--shadow)}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:700px){.chart-row{grid-template-columns:1fr}}

/* Scenario & sensitivity sections */
.section-header{text-align:center;margin:1.5rem 0 1rem}
.section-header h2{font-size:1.3rem;font-weight:700}
.section-header p{color:var(--muted);font-size:.9rem;max-width:650px;margin:.3rem auto 0}

/* Footer */
.footer{text-align:center;padding:2rem;color:var(--muted);font-size:.82rem;border-top:1px solid var(--border);margin-top:2rem}
</style>
</head>
<body>

<div class="header">
  <h1>Will Frontier AI Labs Make Money?</h1>
  <p class="subtitle">A capacity investment game under demand uncertainty: firms commit irreversible compute investment years before knowing if demand will materialize</p>
  <p class="model-note">Inspired by Dixit &amp; Pindyck (1994) &amp; Grenadier (2002) &nbsp;|&nbsp; Two-stage game: invest &rarr; discover demand &rarr; compete on capacity &nbsp;|&nbsp; Anthropic data for reference</p>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="simulator">Simulator</button>
  <button class="tab-btn" data-tab="scenarios">Scenario Comparison</button>
  <button class="tab-btn" data-tab="sensitivity">What Drives Profit?</button>
</div>

<!-- TAB 1: SIMULATOR -->
<div class="container">
<div id="tab-simulator" class="tab-content active">
  <div class="sim-grid">
    <aside class="controls">
      <div class="control-group">
        <h3>Market Demand</h3>
        <div class="slider-row"><label>TAM ($B)</label>
          <input type="range" id="s-TAM0" min="20" max="200" step="5" value="70">
          <span class="val" id="v-TAM0">$70B</span></div>
        <div class="slider-row"><label>Initial Adoption</label>
          <input type="range" id="s-D0" min="3" max="25" step="1" value="10">
          <span class="val" id="v-D0">10%</span></div>
        <div class="slider-row"><label>Max Adoption</label>
          <input type="range" id="s-Dmax" min="30" max="80" step="5" value="55">
          <span class="val" id="v-Dmax">55%</span></div>
      </div>
      <div class="control-group">
        <h3>Investment</h3>
        <div class="slider-row"><label>Yr 1 Compute ($B)</label>
          <input type="range" id="s-initialCapex" min="0.5" max="10" step="0.5" value="2.5">
          <span class="val" id="v-initialCapex">$2.5B</span></div>
        <div class="slider-row"><label>Capex Growth</label>
          <input type="range" id="s-capexGrowth" min="50" max="250" step="10" value="180">
          <span class="val" id="v-capexGrowth">180%</span></div>
        <div class="slider-row"><label>Inference Split (&theta;)</label>
          <input type="range" id="s-theta" min="30" max="80" step="5" value="55">
          <span class="val" id="v-theta">55%</span></div>
      </div>
      <div class="control-group">
        <h3>Competition</h3>
        <div class="slider-row"><label># Frontier Labs (N)</label>
          <input type="range" id="s-nFrontier" min="2" max="7" step="1" value="4">
          <span class="val" id="v-nFrontier">4</span></div>
        <div class="slider-row"><label>Substitutability (&gamma;)</label>
          <input type="range" id="s-gamma" min="0" max="100" step="1" value="75">
          <span class="val" id="v-gamma">0.75</span></div>
      </div>
      <div class="control-group">
        <h3>Open Source</h3>
        <div class="slider-row"><label>OS Quality</label>
          <input type="range" id="s-osQuality0" min="0" max="95" step="1" value="50">
          <span class="val" id="v-osQuality0">0.50</span></div>
        <div class="slider-row"><label>OS Substitutability</label>
          <input type="range" id="s-osSub" min="0" max="90" step="1" value="40">
          <span class="val" id="v-osSub">0.40</span></div>
        <div class="slider-row"><label>% Contestable by OS</label>
          <input type="range" id="s-phi" min="10" max="90" step="5" value="50">
          <span class="val" id="v-phi">50%</span></div>
      </div>

      <button class="advanced-toggle" onclick="toggleAdvanced()">
        <span class="arrow" id="adv-arrow">&#9654;</span> Advanced Parameters
      </button>
      <div class="advanced-content" id="adv-content">
        <div class="control-group" style="margin-top:.6rem">
          <h3>Investment Dynamics</h3>
          <div class="slider-row"><label>Full Growth Years</label>
            <input type="range" id="s-decelStart" min="0" max="5" step="1" value="2">
            <span class="val" id="v-decelStart">2</span></div>
          <div class="slider-row"><label>Growth Deceleration</label>
            <input type="range" id="s-capexDecel" min="40" max="100" step="1" value="60">
            <span class="val" id="v-capexDecel">0.60</span></div>
          <div class="slider-row"><label>Lead Time (&tau; yrs)</label>
            <input type="range" id="s-tau" min="1" max="3" step="1" value="2">
            <span class="val" id="v-tau">2</span></div>
          <div class="slider-row"><label>Efficiency Growth</label>
            <input type="range" id="s-etaGrowth" min="0" max="40" step="5" value="10">
            <span class="val" id="v-etaGrowth">10%</span></div>
        </div>
        <div class="control-group">
          <h3>Market Structure</h3>
          <div class="slider-row"><label>TAM Growth Rate</label>
            <input type="range" id="s-gCapBase" min="10" max="50" step="1" value="30">
            <span class="val" id="v-gCapBase">30%</span></div>
          <div class="slider-row"><label>Switching Cost</label>
            <input type="range" id="s-switchCost0" min="0" max="50" step="1" value="10">
            <span class="val" id="v-switchCost0">0.10</span></div>
          <div class="slider-row"><label>Switch Growth</label>
            <input type="range" id="s-switchGrowth" min="0" max="5" step="0.5" value="1.5">
            <span class="val" id="v-switchGrowth">0.015</span></div>
          <div class="slider-row"><label>&gamma; Drift / Year</label>
            <input type="range" id="s-gammaDrift" min="-5" max="5" step="0.5" value="0">
            <span class="val" id="v-gammaDrift">0.00</span></div>
        </div>
        <div class="control-group">
          <h3>Pricing Dynamics</h3>
          <div class="slider-row"><label>Overcapacity &sigma;</label>
            <input type="range" id="s-sigmaBase" min="50" max="300" step="10" value="150">
            <span class="val" id="v-sigmaBase">1.50</span></div>
          <div class="slider-row"><label>Scarcity Power (&rho;)</label>
            <input type="range" id="s-rho" min="10" max="60" step="5" value="25">
            <span class="val" id="v-rho">0.25</span></div>
          <div class="slider-row"><label>Max Scarcity Premium</label>
            <input type="range" id="s-Smax" min="100" max="300" step="10" value="130">
            <span class="val" id="v-Smax">1.30</span></div>
        </div>
        <div class="control-group">
          <h3>Costs &amp; Other</h3>
          <div class="slider-row"><label>Talent Cost ($B)</label>
            <input type="range" id="s-talentCost0" min="0.3" max="5" step="0.1" value="1.0">
            <span class="val" id="v-talentCost0">$1.0B</span></div>
          <div class="slider-row"><label>Talent Growth</label>
            <input type="range" id="s-talentGrowth" min="5" max="40" step="1" value="15">
            <span class="val" id="v-talentGrowth">15%</span></div>
          <div class="slider-row"><label>OS Catch-up Rate</label>
            <input type="range" id="s-osCatchUp" min="0" max="8" step="0.5" value="3">
            <span class="val" id="v-osCatchUp">0.03</span></div>
          <div class="slider-row"><label>Discount Rate</label>
            <input type="range" id="s-discountRate" min="5" max="20" step="1" value="10">
            <span class="val" id="v-discountRate">10%</span></div>
        </div>
        <div class="control-group">
          <h3>Entry / Exit</h3>
          <div class="checkbox-row">
            <input type="checkbox" id="s-entryExit">
            <label for="s-entryExit">Enable dynamic entry/exit</label>
          </div>
          <div class="entry-exit-params" id="ee-params">
            <div class="slider-row"><label>Exit Threshold ($B)</label>
              <input type="range" id="s-exitThresh" min="3" max="30" step="1" value="12">
              <span class="val" id="v-exitThresh">$12B</span></div>
            <div class="slider-row"><label>Entry Threshold ($B)</label>
              <input type="range" id="s-entryThresh" min="5" max="50" step="1" value="20">
              <span class="val" id="v-entryThresh">$20B</span></div>
            <div class="slider-row"><label>Look-back Years</label>
              <input type="range" id="s-lookback" min="1" max="5" step="1" value="3">
              <span class="val" id="v-lookback">3</span></div>
          </div>
        </div>
      </div>

      <div class="presets">
        <button class="preset-btn bear" onclick="loadPreset('bear')">Bear</button>
        <button class="preset-btn base" onclick="loadPreset('base')">Base</button>
        <button class="preset-btn bull" onclick="loadPreset('bull')">Bull</button>
        <button class="preset-btn agi" onclick="loadPreset('agi')">AGI Shock</button>
      </div>
    </aside>

    <div class="charts">
      <div class="stats">
        <div class="stat-card"><div class="label">2024 Profit</div><div class="value" id="stat-yr1">--</div><div class="sub">per firm</div></div>
        <div class="stat-card"><div class="label">Break-Even Year</div><div class="value" id="stat-beven">--</div><div class="sub">first profitable year</div></div>
        <div class="stat-card"><div class="label">10-Year NPV</div><div class="value" id="stat-npv">--</div><div class="sub">cumulative discounted</div></div>
        <div class="stat-card"><div class="label">Industry Capex</div><div class="value" id="stat-capex">--</div><div class="sub">10yr all firms</div></div>
      </div>
      <div class="chart-box"><div id="chart-rev-cost" style="height:340px"></div></div>
      <div class="chart-box"><div id="chart-cap-demand" style="height:300px"></div></div>
      <div class="chart-row">
        <div class="chart-box"><div id="chart-profit-bar" style="height:300px"></div></div>
        <div class="chart-box"><div id="chart-npv" style="height:300px"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 2: SCENARIOS -->
<div id="tab-scenarios" class="tab-content">
  <div class="section-header">
    <h2>Scenario Comparison</h2>
    <p>Four scenarios: commodity overcapacity (Bear), uncertain break-even (Base), differentiation moat (Bull), and transformative demand explosion (AGI Shock).</p>
  </div>
  <div class="chart-row">
    <div class="chart-box"><div id="chart-sc-profit" style="height:380px"></div></div>
    <div class="chart-box"><div id="chart-sc-util" style="height:380px"></div></div>
  </div>
  <div class="chart-row" style="margin-top:1rem">
    <div class="chart-box"><div id="chart-sc-npv" style="height:380px"></div></div>
    <div class="chart-box"><div id="chart-sc-capdem" style="height:380px"></div></div>
  </div>
  <div style="overflow-x:auto;margin-top:1rem">
    <table id="scenario-table" style="width:100%;border-collapse:collapse;font-size:.88rem;background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)">
      <thead><tr style="background:#f1f5f9">
        <th style="padding:.6rem 1rem;text-align:left">Scenario</th>
        <th style="padding:.6rem 1rem;text-align:right">2024 Profit</th>
        <th style="padding:.6rem 1rem;text-align:right">Break-Even</th>
        <th style="padding:.6rem 1rem;text-align:right">10yr NPV</th>
        <th style="padding:.6rem 1rem;text-align:right">Industry Capex</th>
        <th style="padding:.6rem 1rem;text-align:left">Key Assumptions</th>
      </tr></thead>
      <tbody id="sc-tbody"></tbody>
    </table>
  </div>
</div>

<!-- TAB 3: SENSITIVITY -->
<div id="tab-sensitivity" class="tab-content">
  <div class="section-header">
    <h2>What Drives Profitability?</h2>
    <p>Tornado chart: each bar shows how much 10-year NPV changes when a single parameter swings from pessimistic to optimistic, holding everything else at the base case.</p>
  </div>
  <div class="chart-box"><div id="chart-tornado" style="height:560px"></div></div>
  <div class="section-header" style="margin-top:2rem">
    <h2>Break-Even Frontier</h2>
    <p>What combinations of TAM and substitutability lead to profitability? Green = profitable, red = unprofitable. Black line = break-even boundary.</p>
  </div>
  <div class="chart-box"><div id="chart-breakeven" style="height:500px"></div></div>
</div>
</div>

<div class="footer">
  Two-stage capacity investment game (Dixit &amp; Pindyck, 1994; Grenadier, 2002) with Bass diffusion, segmented OS pressure, and capacity-constrained pricing.
  <br>Model represents a <em>representative frontier firm</em>, not any specific company. Anthropic data shown for reference only. All computations run client-side.
</div>

<script>
// ================================================================
// MODEL: Capacity Investment Game Under Demand Uncertainty
// ================================================================
// Stage 1: Firms commit irreversible compute investment I_t with
//   lead time tau (capacity arrives tau years later).
// Stage 2: Demand D(t) = TAM(capabilities) * Diffusion(adoption)
//   realized; firms compete on capacity-constrained pricing.
//
// Key dynamics:
//   - Overcapacity (u > 1): prices collapse as (1/u)^sigma
//   - Scarcity (u < 1): pricing power as (1/u)^rho, capped at Smax
//   - sigma modulated by gamma_eff (competition intensity)
//   - Training/inference split: theta to serving, (1-theta) to training
//   - Cumulative training expands TAM via scaling laws
//   - Bass S-curve diffusion with overcapacity feedback
//   - Capex growth decelerates over time
// ================================================================

var START_YEAR = 2024;

// Anthropic reference data (shown separately from model output)
var HIST_YEARS = [2024, 2025];
var HIST_REVENUE = [1.0, 4.5];
var HIST_COSTS = [2.0, 6.0];
var HIST_PROFIT = [-1.0, -1.5];

/**
 * Run 10-year capacity investment simulation.
 */
function runSim(p) {
  var ny = p.nYears || 10;
  var N = p.nFrontier;
  var profitHistory = [];
  var capexArr = [];

  var r = {
    year: [], revenue: [], totalCost: [], netProfit: [], cumProfit: [],
    npvCum: [], capex: [], talent: [], TAM: [], diffusion: [],
    D: [], Dfrontier: [], K_i: [], K_total: [], utilization: [],
    nFirms: [], gammaEff: [], osQ: [], switchCost: []
  };

  var cp = 0, cn = 0;
  var prevDfrontier = 0, prevTAM = p.TAM0;

  for (var t = 0; t < ny; t++) {
    // === INVESTMENT with delayed deceleration ===
    // Full growth for first decelStart years, then g(t) decays geometrically
    if (t === 0) {
      capexArr.push(p.initialCapex);
    } else {
      var ds = p.decelStart || 0;
      var gr;
      if (t <= ds) {
        gr = p.capexGrowth;
      } else {
        gr = p.capexGrowth * Math.pow(p.capexDecel || 1, t - ds);
      }
      capexArr.push(capexArr[t - 1] * (1 + gr));
    }
    var I_t = capexArr[t];
    var talent = p.talentCost0 * Math.pow(1 + p.talentGrowth, t);
    var totalCost = I_t + talent + (p.overhead || 0.5);

    // === CAPACITY (from past investment, delayed by tau) ===
    // Before tau: use preInvestFrac * initialCapex as legacy capacity
    var I_past;
    if (t >= p.tau) {
      I_past = capexArr[t - p.tau];
    } else {
      I_past = p.initialCapex * (p.preInvestFrac || 0.8);
    }
    var eta = (p.eta0 || 1) * Math.pow(1 + p.etaGrowth, t);
    var K_i = p.theta * I_past * eta;
    var K_total = N * K_i;

    // === DEMAND: TAM driven by cumulative training (iterative) ===
    var cumTraining = 0;
    for (var s = 0; s <= t; s++) {
      cumTraining += N * (1 - p.theta) * capexArr[s];
    }
    var cumTraining0 = N * (1 - p.theta) * p.initialCapex;
    var logRatio = Math.log(Math.max(cumTraining / cumTraining0, 1));
    var gCap = p.gCapBase + (p.lambda || 0.06) * logRatio;
    var TAM;
    if (t === 0) { TAM = p.TAM0; }
    else { TAM = prevTAM * (1 + gCap); }
    prevTAM = TAM;

    // === DEMAND: Bass diffusion S-curve ===
    // Overcapacity accelerates adoption (price cuts drive adoption)
    var rd = p.rdBase || 0.50;
    if (t > 0 && prevDfrontier > 0 && K_total > prevDfrontier) {
      var overcapRatio = (K_total - prevDfrontier) / prevDfrontier;
      rd = rd + (p.kappa || 0.12) * Math.max(0, overcapRatio);
    }
    var diffusion = p.Dmax / (1 + ((p.Dmax - p.D0) / p.D0) * Math.exp(-rd * t));
    var D = TAM * diffusion;

    // === OPEN SOURCE: segmented market ===
    var phi = p.phi != null ? p.phi : 0.50;
    var osQ = Math.min(p.osQuality0 + (p.osCatchUp || 0.03) * t, p.osMaxQuality || 0.95);
    var osAlpha = osQ * p.osSub;
    // Protected segment (1-phi) immune to OS; contestable segment phi discounted
    var Dfrontier = D * ((1 - phi) + phi * Math.pow(1 - osAlpha, 2));

    // === COMPETITION: capacity-constrained pricing ===
    var u = K_total / Math.max(Dfrontier, 0.01);
    var sc = Math.min(p.switchCost0 + (p.switchGrowth || 0) * t, p.switchMax || 0.50);
    var gm = Math.min(Math.max(p.gamma + (p.gammaDrift || 0) * t, 0), 1);
    var gammaEff = Math.max(gm * (1 - sc), 0);

    // sigma modulated by gamma: high substitutability = worse overcapacity pain
    var sigma = p.sigmaBase * (0.5 + 0.5 * gammaEff);

    var revenue;
    if (u >= 1) {
      // Overcapacity: price collapses
      revenue = (Dfrontier / N) * Math.pow(1 / u, sigma);
    } else {
      // Scarcity: pricing power, but competition erodes rents
      var scarcityMult = Math.min(Math.pow(1 / u, p.rho), p.Smax);
      var competitionErosion = 1 - gammaEff * 0.3 * (N - 1) / N;
      scarcityMult = 1 + (scarcityMult - 1) * Math.max(competitionErosion, 0.1);
      revenue = (Dfrontier / N) * scarcityMult;
    }

    var netProfit = revenue - totalCost;
    prevDfrontier = Dfrontier;
    profitHistory.push(netProfit);

    // === ENTRY/EXIT ===
    if (p.enableEntryExit && profitHistory.length >= (p.lookbackYears || 3)) {
      var lb = p.lookbackYears || 3;
      var recent = profitHistory.slice(-lb);
      var cumR = 0;
      for (var i = 0; i < recent.length; i++) cumR += recent[i];

      if (cumR < -(p.exitThreshold || 12)) {
        N = Math.max(1, N - 1);
      } else {
        var allPos = true;
        for (var i = 0; i < recent.length; i++) { if (recent[i] <= 0) { allPos = false; break; } }
        if (allPos && cumR > (p.entryThreshold || 20)) {
          N = Math.min(p.maxFirms || 7, N + 1);
        }
      }
    }

    // === ACCUMULATE ===
    cp += netProfit;
    cn += netProfit / Math.pow(1 + (p.discountRate || 0.10), t);

    // Store results
    r.year.push(START_YEAR + t);
    r.revenue.push(revenue);
    r.totalCost.push(totalCost);
    r.netProfit.push(netProfit);
    r.cumProfit.push(cp);
    r.npvCum.push(cn);
    r.capex.push(I_t);
    r.talent.push(talent);
    r.TAM.push(TAM);
    r.diffusion.push(diffusion);
    r.D.push(D);
    r.Dfrontier.push(Dfrontier);
    r.K_i.push(K_i);
    r.K_total.push(K_total);
    r.utilization.push(u);
    r.nFirms.push(N);
    r.gammaEff.push(gammaEff);
    r.osQ.push(osQ);
    r.switchCost.push(sc);
  }

  r.totalCapex = r.capex.reduce(function(a, b) { return a + b; }, 0);
  r.industryCapex = r.totalCapex * p.nFrontier;
  return r;
}

// ================================================================
// PRESETS
// ================================================================
var BASE = {
  initialCapex: 2.5, capexGrowth: 1.80, capexDecel: 0.60, decelStart: 2,
  theta: 0.55, eta0: 1.0, etaGrowth: 0.10, tau: 2, preInvestFrac: 0.8,
  TAM0: 70, gCapBase: 0.30, lambda: 0.06,
  D0: 0.10, Dmax: 0.55, rdBase: 0.50, kappa: 0.12,
  nFrontier: 4, gamma: 0.75, gammaDrift: 0,
  switchCost0: 0.10, switchGrowth: 0.015, switchMax: 0.50,
  osQuality0: 0.50, osCatchUp: 0.03, osMaxQuality: 0.95, osSub: 0.40,
  phi: 0.50,
  talentCost0: 1.0, talentGrowth: 0.15, overhead: 0.5,
  sigmaBase: 1.50, rho: 0.25, Smax: 1.30,
  enableEntryExit: false, exitThreshold: 12, entryThreshold: 20,
  lookbackYears: 3, maxFirms: 7,
  nYears: 10, discountRate: 0.10
};

var PRESETS = {
  base: Object.assign({}, BASE),
  bear: Object.assign({}, BASE, {
    gamma: 0.92, nFrontier: 5, switchCost0: 0.03, switchGrowth: 0.005,
    osQuality0: 0.65, osCatchUp: 0.04, osSub: 0.55, phi: 0.65,
    Dmax: 0.45, gCapBase: 0.20, lambda: 0.03,
    Smax: 1.10, sigmaBase: 2.00
  }),
  bull: Object.assign({}, BASE, {
    gamma: 0.55, nFrontier: 3, switchCost0: 0.20, switchGrowth: 0.025,
    osQuality0: 0.40, osCatchUp: 0.02, osSub: 0.30, phi: 0.35,
    Dmax: 0.65, D0: 0.12, gCapBase: 0.35, lambda: 0.07,
    Smax: 1.50, rho: 0.35, sigmaBase: 1.20
  }),
  agi: Object.assign({}, BASE, {
    TAM0: 100, gCapBase: 0.35, lambda: 0.08,
    D0: 0.08, Dmax: 0.70, rdBase: 0.35, kappa: 0.20,
    Smax: 1.80, rho: 0.35, gamma: 0.70
  })
};

var PRESET_LABELS = { bear: 'Bear Case', base: 'Base Case', bull: 'Bull Case', agi: 'AGI Shock' };
var PRESET_COLORS = { bear: '#dc2626', base: '#2563eb', bull: '#16a34a', agi: '#7c3aed' };
var PRESET_NOTES = {
  bear: 'Near-perfect substitutes, 5 competitors, fast OS catch-up, severe overcapacity pricing, small addressable market',
  base: 'Moderate competition and OS pressure, 4 firms, capacity leads demand by 2 years. Calibrated to ~$1B rev 2024.',
  bull: 'Meaningful differentiation, 3 firms, strong switching costs, large addressable market, fast TAM growth',
  agi: 'Transformative capability breakthrough: massive TAM ($80B+), explosive growth, demand outpaces even aggressive investment'
};

// ================================================================
// SLIDER <-> PARAMS
// ================================================================
// Non-slider params that vary by preset (updated when preset loaded)
var _extras = {
  eta0: 1.0, lambda: 0.06, rdBase: 0.50, kappa: 0.12,
  preInvestFrac: 0.8, overhead: 0.5, switchMax: 0.50, osMaxQuality: 0.95
};

function getParams() {
  return {
    TAM0: +gv('TAM0'), D0: gv('D0') / 100, Dmax: gv('Dmax') / 100,
    initialCapex: +gv('initialCapex'), capexGrowth: gv('capexGrowth') / 100,
    theta: gv('theta') / 100,
    nFrontier: +gv('nFrontier'), gamma: gv('gamma') / 100,
    osQuality0: gv('osQuality0') / 100, osSub: gv('osSub') / 100, phi: gv('phi') / 100,
    // Advanced
    decelStart: +gv('decelStart'),
    capexDecel: gv('capexDecel') / 100, tau: +gv('tau'), etaGrowth: gv('etaGrowth') / 100,
    gCapBase: gv('gCapBase') / 100,
    switchCost0: gv('switchCost0') / 100, switchGrowth: gv('switchGrowth') / 100,
    gammaDrift: gv('gammaDrift') / 100,
    sigmaBase: gv('sigmaBase') / 100, rho: gv('rho') / 100, Smax: gv('Smax') / 100,
    talentCost0: +gv('talentCost0'), talentGrowth: gv('talentGrowth') / 100,
    osCatchUp: gv('osCatchUp') / 100, discountRate: gv('discountRate') / 100,
    enableEntryExit: document.getElementById('s-entryExit').checked,
    exitThreshold: +gv('exitThresh'), entryThreshold: +gv('entryThresh'),
    lookbackYears: +gv('lookback'), maxFirms: 7,
    // Non-slider params from current preset
    eta0: _extras.eta0, lambda: _extras.lambda, rdBase: _extras.rdBase,
    kappa: _extras.kappa, preInvestFrac: _extras.preInvestFrac,
    overhead: _extras.overhead, switchMax: _extras.switchMax,
    osMaxQuality: _extras.osMaxQuality,
    nYears: 10
  };
}

function gv(id) { return document.getElementById('s-' + id).value; }

function setParams(p) {
  // Sync non-slider extras from preset
  _extras.eta0 = p.eta0 || 1.0;
  _extras.lambda = p.lambda != null ? p.lambda : 0.06;
  _extras.rdBase = p.rdBase != null ? p.rdBase : 0.50;
  _extras.kappa = p.kappa != null ? p.kappa : 0.12;
  _extras.preInvestFrac = p.preInvestFrac || 0.8;
  _extras.overhead = p.overhead != null ? p.overhead : 0.5;
  _extras.switchMax = p.switchMax || 0.50;
  _extras.osMaxQuality = p.osMaxQuality || 0.95;

  sv('TAM0', p.TAM0); sv('D0', (p.D0 || 0.12) * 100); sv('Dmax', (p.Dmax || 0.55) * 100);
  sv('initialCapex', p.initialCapex); sv('capexGrowth', p.capexGrowth * 100);
  sv('theta', (p.theta || 0.55) * 100);
  sv('nFrontier', p.nFrontier); sv('gamma', p.gamma * 100);
  sv('osQuality0', p.osQuality0 * 100); sv('osSub', p.osSub * 100);
  sv('phi', (p.phi != null ? p.phi : 0.50) * 100);
  sv('decelStart', p.decelStart != null ? p.decelStart : 2);
  sv('capexDecel', (p.capexDecel || 0.60) * 100);
  sv('tau', p.tau || 2); sv('etaGrowth', (p.etaGrowth || 0.10) * 100);
  sv('gCapBase', (p.gCapBase || 0.30) * 100);
  sv('switchCost0', (p.switchCost0 || 0.10) * 100);
  sv('switchGrowth', (p.switchGrowth || 0.015) * 100);
  sv('gammaDrift', (p.gammaDrift || 0) * 100);
  sv('sigmaBase', (p.sigmaBase || 1.50) * 100);
  sv('rho', (p.rho || 0.25) * 100);
  sv('Smax', (p.Smax || 1.30) * 100);
  sv('talentCost0', p.talentCost0); sv('talentGrowth', (p.talentGrowth || 0.15) * 100);
  sv('osCatchUp', (p.osCatchUp || 0.03) * 100);
  sv('discountRate', (p.discountRate || 0.10) * 100);
  document.getElementById('s-entryExit').checked = !!p.enableEntryExit;
  sv('exitThresh', p.exitThreshold || 12); sv('entryThresh', p.entryThreshold || 20);
  sv('lookback', p.lookbackYears || 3);
  toggleEntryExit();
  updateLabels();
}

function sv(id, val) { document.getElementById('s-' + id).value = val; }

function updateLabels() {
  dl('TAM0', '$' + gv('TAM0') + 'B');
  dl('D0', gv('D0') + '%');
  dl('Dmax', gv('Dmax') + '%');
  dl('initialCapex', '$' + (+gv('initialCapex')).toFixed(1) + 'B');
  dl('capexGrowth', gv('capexGrowth') + '%');
  dl('theta', gv('theta') + '%');
  dl('nFrontier', gv('nFrontier'));
  dl('gamma', (gv('gamma') / 100).toFixed(2));
  dl('osQuality0', (gv('osQuality0') / 100).toFixed(2));
  dl('osSub', (gv('osSub') / 100).toFixed(2));
  dl('phi', gv('phi') + '%');
  dl('decelStart', gv('decelStart'));
  dl('capexDecel', (gv('capexDecel') / 100).toFixed(2));
  dl('tau', gv('tau'));
  dl('etaGrowth', gv('etaGrowth') + '%');
  dl('gCapBase', gv('gCapBase') + '%');
  dl('switchCost0', (gv('switchCost0') / 100).toFixed(2));
  dl('switchGrowth', (gv('switchGrowth') / 100).toFixed(3));
  dl('gammaDrift', (gv('gammaDrift') / 100).toFixed(2));
  dl('sigmaBase', (gv('sigmaBase') / 100).toFixed(2));
  dl('rho', (gv('rho') / 100).toFixed(2));
  dl('Smax', (gv('Smax') / 100).toFixed(2));
  dl('talentCost0', '$' + (+gv('talentCost0')).toFixed(1) + 'B');
  dl('talentGrowth', gv('talentGrowth') + '%');
  dl('osCatchUp', (gv('osCatchUp') / 100).toFixed(2));
  dl('discountRate', gv('discountRate') + '%');
  dl('exitThresh', '$' + gv('exitThresh') + 'B');
  dl('entryThresh', '$' + gv('entryThresh') + 'B');
  dl('lookback', gv('lookback'));
}

function dl(id, txt) { document.getElementById('v-' + id).textContent = txt; }

function fmt(v) {
  if (Math.abs(v) >= 1000) return (v > 0 ? '$' : '-$') + Math.abs(v / 1000).toFixed(1) + 'T';
  if (Math.abs(v) >= 1) return (v > 0 ? '$' : '-$') + Math.abs(v).toFixed(1) + 'B';
  return (v > 0 ? '$' : '-$') + (Math.abs(v) * 1000).toFixed(0) + 'M';
}

// ================================================================
// CHART CONFIG
// ================================================================
var plotCfg = { displayModeBar: 'hover', responsive: true,
  modeBarButtonsToRemove: ['select2d', 'lasso2d', 'toImage', 'sendDataToCloud',
    'toggleSpikelines', 'hoverCompareCartesian', 'hoverClosestCartesian'] };
var plotLayout = { margin: { l: 55, r: 20, t: 40, b: 45 },
  font: { family: '-apple-system,sans-serif', size: 12 },
  paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
  xaxis: { gridcolor: '#e2e8f0', dtick: 1 }, yaxis: { gridcolor: '#e2e8f0' } };

// ================================================================
// CHART UPDATES
// ================================================================
function updateSimCharts() {
  var p = getParams(), res = runSim(p);
  var ny = res.year.length;
  var lastYr = START_YEAR + ny - 1;

  // Stats
  setStatVal('stat-yr1', res.netProfit[0]);
  setStatVal('stat-npv', res.npvCum[ny - 1]);

  // Break-even year
  var beven = 'Never';
  for (var i = 0; i < ny; i++) { if (res.netProfit[i] > 0) { beven = '' + res.year[i]; break; } }
  var bevenEl = document.getElementById('stat-beven');
  bevenEl.textContent = beven;
  bevenEl.className = 'value ' + (beven === 'Never' ? 'negative' : 'positive');

  // Industry capex
  document.getElementById('stat-capex').textContent = fmt(res.industryCapex);
  document.getElementById('stat-capex').className = 'value';

  var zeroLine = { type: 'line', x0: START_YEAR, x1: lastYr, y0: 0, y1: 0,
    line: { color: '#94a3b8', width: 1, dash: 'dot' } };

  // Chart 1: Revenue vs Costs + Anthropic reference
  Plotly.react('chart-rev-cost', [
    { x: res.year, y: res.revenue, name: 'Model Revenue', line: { color: PRESET_COLORS.base, width: 2.5 } },
    { x: res.year, y: res.totalCost, name: 'Model Costs', line: { color: PRESET_COLORS.bear, width: 2.5, dash: 'dash' } },
    { x: HIST_YEARS, y: HIST_REVENUE, name: 'Anthropic Rev (ref)', mode: 'markers',
      marker: { size: 10, symbol: 'diamond', color: '#f59e0b', line: { width: 1.5, color: '#b45309' } } },
    { x: HIST_YEARS, y: HIST_COSTS, name: 'Anthropic Cost (ref)', mode: 'markers',
      marker: { size: 10, symbol: 'diamond-open', color: '#f59e0b', line: { width: 2, color: '#b45309' } } }
  ], Object.assign({}, plotLayout, { title: 'Revenue vs. Costs (Representative Firm)',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B' }),
    shapes: [], annotations: [] }), plotCfg);

  // Chart 2: Capacity vs Demand (signature chart)
  // Convert to per-firm for readability
  var perFirmCapacity = res.K_i;
  var perFirmDemand = res.Dfrontier.map(function(d) { return d / p.nFrontier; });

  // Create shapes for overcapacity/scarcity shading
  var capDemShapes = [];
  for (var i = 0; i < ny - 1; i++) {
    var isOvercap = res.utilization[i] >= 1;
    capDemShapes.push({
      type: 'rect', xref: 'x', yref: 'paper',
      x0: res.year[i] - 0.5, x1: res.year[i] + 0.5,
      y0: 0, y1: 1,
      fillcolor: isOvercap ? 'rgba(220,38,38,0.06)' : 'rgba(22,163,74,0.06)',
      line: { width: 0 }
    });
  }

  Plotly.react('chart-cap-demand', [
    { x: res.year, y: perFirmCapacity, name: 'Capacity (per firm)',
      line: { color: PRESET_COLORS.bear, width: 2.5 }, fill: 'none' },
    { x: res.year, y: perFirmDemand, name: 'Demand (per firm)',
      line: { color: PRESET_COLORS.bull, width: 2.5 }, fill: 'none' },
    { x: res.year, y: res.utilization, name: 'Utilization (u)', yaxis: 'y2',
      line: { color: '#f59e0b', width: 2, dash: 'dot' }, opacity: 0.8 }
  ], Object.assign({}, plotLayout, {
    title: 'Capacity vs. Demand & Utilization',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B per firm' }),
    yaxis2: { title: 'Utilization', overlaying: 'y', side: 'right',
      gridcolor: 'rgba(0,0,0,0)', showgrid: false, range: [0, Math.max(6, Math.max.apply(null, res.utilization) * 1.1)] },
    shapes: capDemShapes.concat([
      { type: 'line', xref: 'paper', yref: 'y2', x0: 0, x1: 1, y0: 1, y1: 1,
        line: { color: '#f59e0b', width: 1.5, dash: 'dash' } }
    ]),
    annotations: [
      { x: 1.02, y: 1, xref: 'paper', yref: 'y2', text: 'u=1', showarrow: false,
        font: { size: 10, color: '#f59e0b' }, xanchor: 'left' }
    ]
  }), plotCfg);

  // Chart 3: Net Profit bars
  var barColors = res.netProfit.map(function(v) {
    return v >= 0 ? 'rgba(22,163,74,0.7)' : 'rgba(220,38,38,0.7)';
  });
  Plotly.react('chart-profit-bar', [
    { x: res.year, y: res.netProfit, type: 'bar', marker: { color: barColors },
      hovertemplate: '%{x}: %{y:.1f}B<extra></extra>' }
  ], Object.assign({}, plotLayout, { title: 'Annual Net Profit per Firm', showlegend: false,
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B' }),
    shapes: [zeroLine] }), plotCfg);

  // Chart 4: Cumulative NPV
  Plotly.react('chart-npv', [
    { x: res.year, y: res.cumProfit, name: 'Cumulative Profit',
      line: { color: PRESET_COLORS.base, width: 2 } },
    { x: res.year, y: res.npvCum, name: 'Cumulative NPV',
      line: { color: PRESET_COLORS.bull, width: 2, dash: 'dash' } }
  ], Object.assign({}, plotLayout, { title: 'Cumulative Profit & NPV',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B' }),
    shapes: [zeroLine] }), plotCfg);
}

function setStatVal(id, v) {
  var el = document.getElementById(id);
  el.textContent = fmt(v);
  el.className = 'value ' + (v >= 0 ? 'positive' : 'negative');
}

function updateScenarios() {
  var tracesProfit = [], tracesNpv = [], tracesUtil = [], tracesCapDem = [];
  var tbody = '';
  var keys = ['bear', 'base', 'bull', 'agi'];
  var ny = 10;

  keys.forEach(function(k) {
    var res = runSim(PRESETS[k]);
    var N = PRESETS[k].nFrontier;

    tracesProfit.push({ x: res.year, y: res.netProfit, name: PRESET_LABELS[k],
      line: { color: PRESET_COLORS[k], width: 2.5 }, mode: 'lines+markers', marker: { size: 4 } });

    tracesNpv.push({ x: res.year, y: res.npvCum, name: PRESET_LABELS[k],
      line: { color: PRESET_COLORS[k], width: 2.5 }, mode: 'lines+markers', marker: { size: 4 } });

    tracesUtil.push({ x: res.year, y: res.utilization, name: PRESET_LABELS[k],
      line: { color: PRESET_COLORS[k], width: 2.5 }, mode: 'lines+markers', marker: { size: 4 } });

    // Capacity gap = K_total - Dfrontier (positive = overcapacity)
    var capGap = [];
    for (var i = 0; i < ny; i++) capGap.push(res.K_total[i] - res.Dfrontier[i]);
    tracesCapDem.push({ x: res.year, y: capGap, name: PRESET_LABELS[k],
      line: { color: PRESET_COLORS[k], width: 2.5 }, mode: 'lines+markers', marker: { size: 4 } });

    var beven = 'Never';
    for (var i = 0; i < ny; i++) { if (res.netProfit[i] > 0) { beven = '' + res.year[i]; break; } }

    var c = function(v) { return '<span style="color:' + (v >= 0 ? '#16a34a' : '#dc2626') + '">' + fmt(v) + '</span>'; };
    tbody += '<tr style="border-top:1px solid #e2e8f0"><td style="padding:.5rem 1rem;font-weight:600;color:' +
      PRESET_COLORS[k] + '">' + PRESET_LABELS[k] + '</td><td style="padding:.5rem 1rem;text-align:right">' +
      c(res.netProfit[0]) + '</td><td style="padding:.5rem 1rem;text-align:right">' + beven +
      '</td><td style="padding:.5rem 1rem;text-align:right">' + c(res.npvCum[ny - 1]) +
      '</td><td style="padding:.5rem 1rem;text-align:right">' + fmt(res.industryCapex) +
      '</td><td style="padding:.5rem 1rem;font-size:.8rem;color:#64748b">' + PRESET_NOTES[k] + '</td></tr>';
  });

  document.getElementById('sc-tbody').innerHTML = tbody;

  var zeroLine = { type: 'line', x0: START_YEAR, x1: START_YEAR + ny - 1, y0: 0, y1: 0,
    line: { color: '#94a3b8', width: 1, dash: 'dot' } };
  var oneLine = { type: 'line', x0: START_YEAR, x1: START_YEAR + ny - 1, y0: 1, y1: 1,
    line: { color: '#f59e0b', width: 1.5, dash: 'dash' } };

  Plotly.react('chart-sc-profit', tracesProfit, Object.assign({}, plotLayout, {
    title: 'Annual Net Profit per Firm',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B' }),
    shapes: [zeroLine] }), plotCfg);

  Plotly.react('chart-sc-util', tracesUtil, Object.assign({}, plotLayout, {
    title: 'Utilization (u) — Above 1 = Overcapacity',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: 'Utilization Ratio' }),
    shapes: [oneLine],
    annotations: [{ x: START_YEAR + 0.5, y: 1, text: 'Overcapacity above this line',
      showarrow: false, font: { size: 10, color: '#f59e0b' }, yshift: 12 }]
  }), plotCfg);

  Plotly.react('chart-sc-npv', tracesNpv, Object.assign({}, plotLayout, {
    title: 'Cumulative NPV per Firm',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B' }),
    shapes: [zeroLine] }), plotCfg);

  Plotly.react('chart-sc-capdem', tracesCapDem, Object.assign({}, plotLayout, {
    title: 'Capacity Gap (K - D): Positive = Overcapacity',
    yaxis: Object.assign({}, plotLayout.yaxis, { title: '$B (industry)' }),
    shapes: [zeroLine] }), plotCfg);
}

function updateSensitivity() {
  // Tornado chart
  var sensParams = [
    ['TAM0', 25, 100, 'Total Addressable Market'],
    ['D0', 0.05, 0.20, 'Initial Adoption Rate'],
    ['Dmax', 0.35, 0.75, 'Max Adoption'],
    ['nFrontier', 6, 2, '# Frontier Labs'],
    ['gamma', 0.95, 0.45, 'Substitutability (gamma)'],
    ['capexGrowth', 1.30, 0.60, 'Capex Growth Rate'],
    ['initialCapex', 2.5, 0.5, 'Yr 1 Compute ($B)'],
    ['theta', 0.35, 0.75, 'Inference Split (theta)'],
    ['osQuality0', 0.75, 0.25, 'OS Quality'],
    ['osSub', 0.65, 0.20, 'OS Substitutability'],
    ['phi', 0.75, 0.25, '% Contestable by OS'],
    ['switchCost0', 0.02, 0.30, 'Switching Costs'],
    ['gCapBase', 0.20, 0.40, 'TAM Growth Rate'],
    ['lambda', 0.02, 0.10, 'Training → TAM Feedback'],
    ['sigmaBase', 2.50, 0.80, 'Overcapacity Sensitivity'],
    ['Smax', 1.05, 2.00, 'Max Scarcity Premium'],
    ['capexDecel', 0.70, 0.95, 'Growth Deceleration'],
    ['talentCost0', 2.0, 0.3, 'Talent Cost ($B)'],
    ['rho', 0.10, 0.50, 'Scarcity Power (rho)']
  ];
  var baseNpv = runSim(BASE).npvCum[9];
  var impacts = [];
  sensParams.forEach(function(sp) {
    var pLow = Object.assign({}, BASE); pLow[sp[0]] = sp[1];
    var pHigh = Object.assign({}, BASE); pHigh[sp[0]] = sp[2];
    var nL = runSim(pLow).npvCum[9] - baseNpv;
    var nH = runSim(pHigh).npvCum[9] - baseNpv;
    impacts.push({ name: sp[3], low: nL, high: nH, range: Math.abs(nH - nL) });
  });
  impacts.sort(function(a, b) { return a.range - b.range; });
  var names = impacts.map(function(i) { return i.name; });
  var highs = impacts.map(function(i) { return i.high; });
  var lows = impacts.map(function(i) { return i.low; });
  Plotly.react('chart-tornado', [
    { y: names, x: highs, type: 'bar', orientation: 'h', name: 'Optimistic',
      marker: { color: 'rgba(22,163,74,0.7)' } },
    { y: names, x: lows, type: 'bar', orientation: 'h', name: 'Pessimistic',
      marker: { color: 'rgba(220,38,38,0.7)' } }
  ], Object.assign({}, plotLayout, {
    title: 'Sensitivity: Change in 10-Year NPV ($B)', barmode: 'overlay',
    margin: { l: 200, r: 30, t: 40, b: 50 },
    xaxis: Object.assign({}, plotLayout.xaxis, { title: 'Change in NPV ($B)', zeroline: true, zerolinewidth: 2 }),
    yaxis: { automargin: true }
  }), plotCfg);

  // Break-even heatmap: TAM0 vs gamma
  var tRows = 40, gRows = 40;
  var tRange = [], gRange = [], zData = [];
  for (var ti = 0; ti < tRows; ti++) { tRange.push(15 + ti * 135 / (tRows - 1)); }
  for (var gi = 0; gi < gRows; gi++) { gRange.push(0.30 + gi * 0.65 / (gRows - 1)); }
  for (var gi = 0; gi < gRows; gi++) {
    var row = [];
    for (var ti = 0; ti < tRows; ti++) {
      var pp = Object.assign({}, BASE);
      pp.TAM0 = tRange[ti]; pp.gamma = gRange[gi];
      row.push(runSim(pp).npvCum[9]);
    }
    zData.push(row);
  }
  var xLabels = tRange.map(function(t) { return '$' + t.toFixed(0) + 'B'; });
  var yLabels = gRange.map(function(g) { return g.toFixed(2); });

  Plotly.react('chart-breakeven', [{
    z: zData, x: xLabels, y: yLabels,
    type: 'heatmap', colorscale: [[0, '#dc2626'], [0.5, '#fefce8'], [1, '#16a34a']],
    zmid: 0, colorbar: { title: 'NPV ($B)' }
  }, {
    x: xLabels, y: yLabels, z: zData,
    type: 'contour', contours: { start: 0, end: 0, size: 1 }, showscale: false,
    line: { color: 'black', width: 3 }, ncontours: 1
  }], Object.assign({}, plotLayout, {
    title: 'Break-Even Frontier: TAM vs. Substitutability',
    margin: { l: 60, r: 30, t: 40, b: 60 },
    xaxis: { title: 'Total Addressable Market (TAM₀)' },
    yaxis: { title: 'Substitutability (gamma)' },
    annotations: [
      { x: '$' + BASE.TAM0 + 'B', y: BASE.gamma.toFixed(2), text: '<b>Base</b>',
        showarrow: true, arrowhead: 2, ax: 40, ay: -35,
        font: { size: 12, color: '#1e293b' }, bgcolor: 'rgba(255,255,255,0.85)', borderpad: 3 },
      { x: '$' + PRESETS.bear.TAM0 + 'B', y: PRESETS.bear.gamma.toFixed(2), text: '<b>Bear</b>',
        showarrow: true, arrowhead: 2, ax: -55, ay: 5,
        font: { size: 12, color: '#dc2626' }, bgcolor: 'rgba(255,255,255,0.85)', borderpad: 3 },
      { x: '$' + PRESETS.bull.TAM0 + 'B', y: PRESETS.bull.gamma.toFixed(2), text: '<b>Bull</b>',
        showarrow: true, arrowhead: 2, ax: 10, ay: 45,
        font: { size: 12, color: '#16a34a' }, bgcolor: 'rgba(255,255,255,0.85)', borderpad: 3 }
    ]
  }), plotCfg);
}

// ================================================================
// UI HANDLERS
// ================================================================
function toggleAdvanced() {
  var c = document.getElementById('adv-content');
  var a = document.getElementById('adv-arrow');
  c.classList.toggle('open'); a.classList.toggle('open');
}
function toggleEntryExit() {
  var checked = document.getElementById('s-entryExit').checked;
  var params = document.getElementById('ee-params');
  if (checked) params.classList.add('open');
  else params.classList.remove('open');
}
function loadPreset(name) {
  setParams(PRESETS[name]); updateSimCharts();
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'scenarios') updateScenarios();
    if (btn.dataset.tab === 'sensitivity') updateSensitivity();
  });
});

// Slider & checkbox events
document.querySelectorAll('input[type=range]').forEach(function(s) {
  s.addEventListener('input', function() { updateLabels(); updateSimCharts(); });
});
document.getElementById('s-entryExit').addEventListener('change', function() {
  toggleEntryExit(); updateSimCharts();
});

// Init
updateLabels();
updateSimCharts();
</script>
</body>
</html>
